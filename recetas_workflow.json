{
  "name": "RECETAS-AI-Auto-Publisher",
  "nodes": [
    {
      "id": "schedule-trigger",
      "name": "Cada 12 Horas",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [100, 300],
      "parameters": {
        "rule": {
          "interval": [
            { "field": "hours", "hoursInterval": 12 }
          ]
        }
      }
    },
    {
      "id": "dish-namer",
      "name": "Nombrador de Plato",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [340, 300],
      "parameters": {
        "method": "POST",
        "url": "https://api.x.ai/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer xai-TU_API_KEY_DE_GROK_AQUI" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'grok-2-mini', max_tokens: 30, messages: [ { role: 'system', content: 'Eres un experto en gastronom√≠a ecuatoriana. Solo respondes con nombres de platos.' }, { role: 'user', content: 'Dame el nombre de un plato t√≠pico ecuatoriano poco conocido o una variaci√≥n original (ejemplos: Ceviche de Chochos, Empanadas de Morocho, Sopa de Quinua con Pollo, Tigrillo de Verde, Muchines de Yuca, Colada Morada de Arroz, Caldo de 31). No repitas platos muy comunes como Llapingachos o Ceviche de camar√≥n. Solo responde con el nombre del plato, sin explicaciones, sin puntuaci√≥n al final.' } ] }) }}",
        "options": {}
      }
    },
    {
      "id": "chef-redactor",
      "name": "Chef Redactor",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [580, 300],
      "parameters": {
        "method": "POST",
        "url": "https://api.x.ai/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "Bearer xai-TU_API_KEY_DE_GROK_AQUI" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: 'grok-2', max_tokens: 2500, messages: [ { role: 'system', content: 'Eres un equipo de tres expertos combinados en un solo prompt:\\n\\n1. CHEF ECUATORIANO PROFESIONAL: Conoces todas las recetas regionales del Ecuador (Sierra, Costa, Amazon√≠a, Gal√°pagos) con profundidad gastron√≥mica, proporciones exactas, t√©cnicas de cocci√≥n y variantes regionales.\\n\\n2. GU√çA TUR√çSTICO Y CONSULTOR DE DI√ÅSPORA: Para platos con ingredientes dif√≠ciles de conseguir fuera de Ecuador, sabes exactamente qu√© sustitutos usar en EE.UU. y Europa. Tambi√©n conoces d√≥nde probar cada plato en Ecuador (mercados, restaurantes, ciudades).\\n\\n3. EXPERTO SEO CULINARIO: Escribes t√≠tulos y descripciones optimizados para Google Search. Generas keywords long-tail relevantes.\\n\\nRESPONDE √öNICAMENTE con JSON v√°lido, sin markdown, sin explicaciones.' }, { role: 'user', content: 'Crea la receta completa para: ' + $json.choices[0].message.content + '\\n\\nResponde con un objeto JSON que siga EXACTAMENTE este esquema (incluye los campos opcionales cuando sean relevantes):\\n{\\n  \"slug\": \"nombre-kebab-case-sin-acentos\",\\n  \"title\": \"Nombre del Plato\",\\n  \"description\": \"Descripci√≥n apetitosa de m√°ximo 120 caracteres\",\\n  \"region\": \"Sierra|Costa|Amazonia|Galapagos\",\\n  \"category\": \"Sopas|Platos Fuertes|Entradas|Postres|Bebidas|Desayunos|Mariscos\",\\n  \"difficulty\": \"F√°cil|Media|Dif√≠cil\",\\n  \"servings\": \"X personas\",\\n  \"prep_time\": \"X min\",\\n  \"cook_time\": \"X min\",\\n  \"total_time\": \"X min\",\\n  \"image_url\": \"https://images.unsplash.com/photo-XXXX?w=800&q=80\",\\n  \"ingredients\": [\"cantidad ingrediente\"],\\n  \"instructions\": [\"Paso 1...\", \"Paso 2...\"],\\n  \"tips\": [\"Tip 1...\", \"Tip 2...\"],\\n  \"keywords\": [\"keyword1\", \"keyword2\"],\\n  \"date_published\": \"2026-02-23\",\\n  \"target_audience\": \"Di√°spora\",\\n  \"international_substitutes\": [{\"original\": \"...\", \"sustituto_usa\": \"...\", \"sustituto_europa\": \"...\"}],\\n  \"tourism_route\": \"üìç [Ciudad]: [Lugar]. [Descripci√≥n]. Precio: $X-Y USD.\"\\n}\\n\\nREGLAS:\\n- Incluye international_substitutes si el plato usa ingredientes dif√≠ciles fuera de Ecuador.\\n- Incluye tourism_route si el plato tiene una ruta gastron√≥mica clara.\\n- Para platos muy locales (fritada, hornado, yaguarlocro), incluye AMBOS campos opcionales.\\n- M√≠nimo 8 ingredientes con cantidades exactas, 6 pasos de instrucciones, 2-4 tips.\\n- keywords: 5-8 t√©rminos incluyendo variantes regionales y long-tail.' } ] }) }}",
        "options": {}
      }
    },
    {
      "id": "parse-recipe",
      "name": "Parsear Receta JSON",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [820, 300],
      "parameters": {
        "jsCode": "// Leer respuesta de Grok (formato OpenAI-compatible)\nconst raw = $input.first().json.choices?.[0]?.message?.content || $input.first().json.text || '';\n\nconst cleaned = raw.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n\nlet recipe;\ntry {\n  recipe = JSON.parse(cleaned);\n} catch(e) {\n  throw new Error('JSON inv√°lido de Grok: ' + e.message + ' | Inicio: ' + cleaned.slice(0, 200));\n}\n\nif (!recipe.title || !recipe.slug) {\n  throw new Error('Faltan campos requeridos title/slug: ' + JSON.stringify(recipe).slice(0, 200));\n}\n\nrecipe.slug = recipe.slug\n  .toLowerCase().trim()\n  .replace(/[√°√†√§√¢]/g, 'a').replace(/[√©√®√´√™]/g, 'e')\n  .replace(/[√≠√¨√Ø√Æ]/g, 'i').replace(/[√≥√≤√∂√¥]/g, 'o')\n  .replace(/[√∫√π√º√ª]/g, 'u').replace(/√±/g, 'n')\n  .replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-')\n  .replace(/^-|-$/g, '');\n\nreturn [{ json: recipe }];"
      }
    },
    {
      "id": "get-github",
      "name": "GET recipes.json (GitHub)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1060, 300],
      "parameters": {
        "method": "GET",
        "url": "https://api.github.com/repos/LordRa2pat/recetas-ecuador/contents/recipes.json",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "token ghp_TU_TOKEN_DE_GITHUB_AQUI" },
            { "name": "Accept", "value": "application/vnd.github.v3+json" },
            { "name": "User-Agent", "value": "n8n-recetas-ecuador-bot" }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "merge-commit",
      "name": "Merge + Preparar Commit",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 300],
      "parameters": {
        "jsCode": "const newRecipe = $('Parsear Receta JSON').first().json;\nconst githubData = $input.first().json;\nconst fileSha = githubData.sha;\n\nconst currentContent = Buffer.from(githubData.content, 'base64').toString('utf8');\n\nlet recipes = [];\ntry {\n  recipes = JSON.parse(currentContent);\n  if (!Array.isArray(recipes)) recipes = [];\n} catch(e) { recipes = []; }\n\nif (recipes.some(r => r.slug === newRecipe.slug)) {\n  throw new Error('DUPLICADO_SLUG: ' + newRecipe.slug);\n}\n\nconst maxId = recipes.reduce((max, r) => Math.max(max, Number(r.id) || 0), 0);\nnewRecipe.id = maxId + 1;\nnewRecipe.created_at = new Date().toISOString();\n\nrecipes.unshift(newRecipe);\n\nconst newContent = Buffer.from(JSON.stringify(recipes, null, 2), 'utf8').toString('base64');\n\nreturn [{ json: { sha: fileSha, content: newContent, slug: newRecipe.slug, title: newRecipe.title, id: newRecipe.id, total: recipes.length } }];"
      }
    },
    {
      "id": "put-github",
      "name": "PUT recipes.json a GitHub",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 300],
      "parameters": {
        "method": "PUT",
        "url": "https://api.github.com/repos/LordRa2pat/recetas-ecuador/contents/recipes.json",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "token ghp_TU_TOKEN_DE_GITHUB_AQUI" },
            { "name": "Accept", "value": "application/vnd.github.v3+json" },
            { "name": "User-Agent", "value": "n8n-recetas-ecuador-bot" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { message: 'feat(recetas): agregar ' + $json.slug + ' [ID:' + $json.id + '] ‚Äî auto publicado por n8n+Grok', content: $json.content, sha: $json.sha } }}",
        "options": {}
      }
    },
    {
      "id": "sticky-note",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [100, 120],
      "parameters": {
        "content": "## RECETAS-AI-Auto-Publisher v2.0 ‚Äî Grok (xAI)\n\n**Flujo:** Schedule (12h) ‚Üí Nombrador de Plato (grok-2-mini) ‚Üí Chef Redactor (grok-2) ‚Üí Parsear JSON ‚Üí GET GitHub ‚Üí Merge + ID autoincremental ‚Üí PUT GitHub ‚Üí Vercel rebuild\n\n**AI:** xAI Grok via https://api.x.ai/v1/chat/completions\n**Audiencias:** Local üá™üá® + Di√°spora ‚úàÔ∏è + Turismo üó∫Ô∏è\n\n‚ö†Ô∏è Reemplaza xai-TU_API_KEY_DE_GROK_AQUI y ghp_TU_TOKEN_DE_GITHUB_AQUI antes de activar.",
        "height": 160,
        "width": 1520
      }
    }
  ],
  "connections": {
    "Cada 12 Horas": {
      "main": [[{ "node": "Nombrador de Plato", "type": "main", "index": 0 }]]
    },
    "Nombrador de Plato": {
      "main": [[{ "node": "Chef Redactor", "type": "main", "index": 0 }]]
    },
    "Chef Redactor": {
      "main": [[{ "node": "Parsear Receta JSON", "type": "main", "index": 0 }]]
    },
    "Parsear Receta JSON": {
      "main": [[{ "node": "GET recipes.json (GitHub)", "type": "main", "index": 0 }]]
    },
    "GET recipes.json (GitHub)": {
      "main": [[{ "node": "Merge + Preparar Commit", "type": "main", "index": 0 }]]
    },
    "Merge + Preparar Commit": {
      "main": [[{ "node": "PUT recipes.json a GitHub", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "active": false
}
